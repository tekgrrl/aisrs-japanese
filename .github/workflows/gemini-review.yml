name: 'ðŸ”Ž Gemini 3.0 Review'

on:
  workflow_call:
    inputs:
      additional_context:
        type: 'string'
        description: 'Any additional context from the request'
        required: false

concurrency:
  group: '${{ github.workflow }}-review-${{ github.event_name }}-${{ github.event.pull_request.number || github.event.issue.number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  review:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 10
    permissions:
      contents: 'read'
      id-token: 'write'
      issues: 'write'
      pull-requests: 'write'
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: |-
          ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@v2'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          permission-contents: 'read'
          permission-issues: 'write'
          permission-pull-requests: 'write'

      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'

      - name: 'Run Gemini 3.0 Review'
        uses: 'google-github-actions/run-gemini-cli@v0'
        id: 'gemini_pr_review'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}'
          ISSUE_TITLE: '${{ github.event.pull_request.title || github.event.issue.title }}'
          ISSUE_BODY: '${{ github.event.pull_request.body || github.event.issue.body }}'
          PULL_REQUEST_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
          REPOSITORY: '${{ github.repository }}'
          ADDITIONAL_CONTEXT: '${{ inputs.additional_context }}'
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_model: 'gemini-3-flash-preview' # If this model ID fails, fallback to 'gemini-2.0-flash-exp' or 'gemini-1.5-pro'
          settings: |-
            {
              "model": {
                "maxSessionTurns": 50,
                "temperature": 0.1
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run", "-i", "--rm",
                    "-e", "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server:v0.18.0"
                  ],
                  "includeTools": [
                    "add_comment_to_pending_review",
                    "create_pending_pull_request_review",
                    "pull_request_read",
                    "submit_pending_pull_request_review"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              },
              "tools": {
                "core": [
                  "run_shell_command(cat)",
                  "run_shell_command(grep)",
                  "run_shell_command(ls)"
                ]
              }
            }
          prompt: |-
            ## Role
            You are a Gemini 3.0 Agentic Reviewer. You are highly skeptical and focus on logic, security, and Japanese language processing (AISRS-Japanese context).

            ## The Context-Verification Mandate (CRITICAL)
            To prevent hallucinating line numbers or commenting on the wrong code:
            1. BEFORE drafting a comment, use `mcp__github__pull_request_read.get_diff` to identify changes.
            2. **MANDATORY**: For any file you intend to comment on, you MUST first run `run_shell_command(cat <filename>)` to read the actual file content.
            3. Compare the diff line numbers against the `cat` output to ensure your `suggestion` block is 100% accurate. If the mapping is unclear, do not post the comment.

            ## Operational Constraints
            - Scope: Only comment on lines marked with `+` or `-` in the diff.
            - Persona: Be a senior engineer. Ignore stylistic nitpicks. Focus on logic flaws, SRS algorithm edge cases, and encoding/parsing issues related to Japanese text.
            - Suggestion Validity: Every suggestion must be syntactically correct and match the existing indentation exactly.

            ## Execution Workflow
            Step 1: Get PR diff and metadata.
            Step 2: List changed files. For each file with logical changes, use `cat` to verify the surrounding context.
            Step 3: Draft specific, high-severity comments (ðŸ”´/ðŸŸ ) using the tools.
            Step 4: Use `mcp__github__submit_pending_pull_request_review` with the "COMMENT" event type to finalize.

            ## Severity Levels
            - ðŸ”´ Critical: Logic bugs, SRS timing failures, memory leaks.
            - ðŸŸ  High: Significant technical debt, potential crashes.
            - ðŸŸ¡ Medium: Language-specific best practices for Japanese (e.g., normalization issues).
            - ðŸŸ¢ Low: Typos (only if they break the code/UI).

            Input Data:
            - Repository: ${{ env.REPOSITORY }}
            - PR #: ${{ env.PULL_REQUEST_NUMBER }}
            - User Context: ${{ env.ADDITIONAL_CONTEXT }}
